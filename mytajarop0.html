<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ… - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* CSS Variables for Easy Theming */
        :root {
            --bg-color: #f0f0f0;
            --main-bg: #ffffff;
            --header-bg: #070607;
            --header-text: #ffffff;
            --card-bg: #252525;
            --text-color: #ffffff;
            --input-bg: #444444;
            --primary-color: #3498db; 
            --secondary-color: #6c5ce7;
            --warning-color: #ffc107; 
            --delete-color: #e74c3c; 
            --border-color: rgba(255, 255, 255, 0.12);
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Base & Reset */
        html, body {
            font-family: 'Tajawal', sans-serif !important;
            -webkit-text-size-adjust: 100%;
            box-sizing: border-box;
            background: var(--bg-color);
            color: #333;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            width: 100%;
            overflow-x: hidden;
        }

        /* Header */
        header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 15px 16px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
            width: 100%;
        }
        .date-display { font-size: 16px; font-weight: 400; margin-top: 4px; opacity: 0.8; }

        /* **Layout & Towsit (Ø§Ù„ØªÙˆØ³ÙŠØ·)** */
        .main-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 16px;
            flex-grow: 1;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr minmax(350px, 450px);
            gap: 20px;
            margin-bottom: 20px;
        }
        @media(max-width: 950px) {
            .grid { grid-template-columns: 1fr; }
            .form-card { order: 1; } 
            .matches-wrapper { order: 2; } 
        }
        
        /* Card & Form Styles */
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            color: var(--text-color);
        }
        .card-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: var(--primary-color); }
        .row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; flex-wrap: nowrap; }
        .row > div { flex-grow: 1; min-width: 0; }
        @media(max-width: 600px) {
            .row { flex-wrap: wrap; }
            .row > div { min-width: 45%; }
        }
        
        select, input[type="time"] {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: 8px;
            color: var(--text-color);
            width: 100%;
            appearance: none;
        }
        label { font-size: 14px; color: var(--text-color); display: block; margin-bottom: 6px; font-weight: 500; }
        
        .logo-preview-wrapper { width: 50px; flex-shrink: 0; }
        .logo-preview {
            height: 40px; width: 100%; border-radius: 8px; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            background: var(--input-bg); font-size: 20px;
        }
        .logo-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .button-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; }
        .btn {
            color: #fff; padding: 12px 18px; border-radius: 10px; border: none; cursor: pointer;
            font-weight: 700; transition: background-color 0.2s; flex-shrink: 0; font-size: 15px;
        }
        .primary-btn { background: var(--primary-color); flex: 1; }
        .secondary-btn { background: var(--secondary-color); flex-basis: 150px; }
        .tertiary-btn { background: #3c3c3c; }
        .delete-btn { background: var(--delete-color); }
        .download-btn { background: #27ae60; width: 100%; display: block; }
        .margin-top-1 { margin-top: 8px; }

        .system-message {
            padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center;
            font-weight: 500; color: white;
        }
        .error-message { background: var(--delete-color); }
        .success-message { background: #2ecc71; }
        .warning-message { background: var(--warning-color); color: #333; }
        .hidden { display: none !important; }

        /* Matches Display */
        .matches-section { margin-bottom: 20px; }
        
        .section-header {
            display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 17px;
            margin-bottom: 10px; padding-right: 12px; border-right: 5px solid var(--primary-color);
            color: #333; justify-content: space-between;
        }
        .section-header-content { display: flex; align-items: center; gap: 10px; }
        .league-logo { width: 30px; height: 30px; object-fit: contain; }
        .extra-logo-header { height: 26px; opacity: 0.8; }
        
        .match-card {
            background-color: var(--match-card-bg, #191919);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 6px;
            position: relative;
            overflow: hidden;
            background-image: url('https://falahsab.github.io/jedwal/img/yemen-sat0.png');
            background-repeat: repeat;
            background-size: 60px auto;
            background-blend-mode: overlay;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: var(--text-color);
        }
        .match-card::before {
            content: ""; position: absolute; inset: 0;
            background-color: var(--match-card-bg, #191919);
            opacity: 0.96; z-index: 0;
        }
        .match-card > * { position: relative; z-index: 1; }
        .match-card.is-editing { border: 3px solid var(--warning-color); box-shadow: 0 0 10px var(--warning-color); }

        .match_row {
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
            min-width: 100%;
        }

        .middle_column {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 700; font-size: clamp(18px, 4vw, 26px); line-height: 1.1;
            flex-shrink: 0; min-width: 70px; max-width: 90px; width: 25%;
        }

        .team {
            display: flex; align-items: center; gap: 8px; flex: 1 1 0%; min-width: 0; overflow: hidden;
        }
        .team.hometeam { justify-content: flex-end; text-align: right; }
        .team.awayteam { justify-content: flex-start; text-align: left; }

        .team_logo { width: clamp(35px, 5vw, 45px); height: clamp(35px, 5vw, 45px); object-fit: contain; flex-shrink: 0; }

        .the_team {
            font-weight: 700; font-size: clamp(15px, 3vw, 20px); overflow: hidden;
            text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; flex-shrink: 1; min-width: 10px;
        }

        .the_time { display: flex; align-items: center; gap: 4px; justify-content: center; font-size: 1em; }
        .next-day-label { font-size: 11px; color: #98999a; margin-top: 5px; line-height: 1; }
        
        .meta {
            display: flex; justify-content: center; align-items: center; gap: 30px;
            font-size: 14px; color: #efeded; margin-top: 10px; font-weight: 500; flex-wrap: wrap;
            text-align: center; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.05);
        }

        .action-btns {
            display: flex; gap: 8px; margin-top: 15px; justify-content: center;
            flex-wrap: wrap; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05);
        }
        .action-btns button {
            padding: 8px 12px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 13px; font-weight: 600; transition: opacity 0.2s;
        }
        
        .channel-logo {
            position: absolute; bottom: 10px; left: 10px; width: auto; height: 35px;
            object-fit: contain; z-index: 3;
        }
        
        .card-footer-text { font-size: 13px; color: #98999a; margin-top: 15px; text-align: center; }

        /* Print Styles */
        @media print {
            .main-container, .form-card, header, .action-btns, #downloadTable, .card-footer-text, #toggleBtns, #deleteAll, #nextDayBtn, #finalView {
                display: none !important;
            }
            .matches-wrapper { margin: 0; box-shadow: none; }
            .card { box-shadow: none; background: none; padding: 0; }
        }
    </style>
</head>
<body>

    <header>
        âš½ Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
        <div id="todayDate" class="date-display"></div>
    </header>

    <div class="main-container">

        <div class="grid">
            <div class="matches-wrapper">
                <div class="card">
                    <div id="matchesContainer">
                        <div class="loading-spinner" style="text-align:center; padding:30px; color:#aaa;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
                    </div>
                    <center class="card-footer-text">Ù…Ø¹ vip Ø¹ÙŠØ´ Ø§Ù„Ù…ØªØ¹Ø© .. Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†</center>
                </div>
                
                <button id="finalView" class="btn primary-btn margin-top-1">ğŸ”— Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
                <button id="downloadTable" class="btn download-btn margin-top-1">ğŸ“¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙƒØµÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø©</button>
                <a id="downloadLink" class="hidden"></a>
            </div>

            <div class="card form-card">
                <h2 class="card-title">Ø¥Ø¯Ø®Ø§Ù„/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</h2>
                
                <div id="systemMessage" class="system-message hidden"></div>

                <div class="row">
                    <div style="flex:1"><label for="leagueSelect">Ø§Ù„Ø¯ÙˆØ±ÙŠ</label><select id="leagueSelect" required></select></div>
                    <div style="width:120px; flex-grow: 0;"><label for="matchTime">Ø§Ù„ÙˆÙ‚Øª</label><input id="matchTime" type="time" required /></div>
                </div>
                <div class="row">
                    <div style="flex:1"><label for="homeTeam">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø¶ÙŠÙ</label><select id="homeTeam" required></select></div>
                    <div class="logo-preview-wrapper"><label>&nbsp;</label><div class="logo-preview" id="homePreview">ğŸ </div></div>
                </div>
                <div class="row">
                    <div style="flex:1"><label for="awayTeam">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¶ÙŠÙ</label><select id="awayTeam" required></select></div>
                    <div class="logo-preview-wrapper"><label>&nbsp;</label><div class="logo-preview" id="awayPreview">âš½</div></div>
                </div>
                <div class="row">
                    <div style="flex:1"><label for="commentator">Ø§Ù„Ù…Ø¹Ù„Ù‚</label><select id="commentator" required></select></div>
                    <div style="width:180px; flex-grow: 1;"><label for="channel">Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù†Ø§Ù‚Ù„Ø©</label><select id="channel" required></select></div>
                </div>

                <div class="button-group">
                    <button id="addMatch" class="btn primary-btn">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</button>
                    <button id="nextDayBtn" class="btn secondary-btn">
                        ğŸ“… Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ: <span id="nextDayState">âŒ</span>
                    </button>
                </div>

                <button id="toggleBtns" class="btn tertiary-btn margin-top-1">ğŸ‘ï¸ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù</button>
                <button id="deleteAll" class="btn delete-btn margin-top-1">ğŸ—‘ï¸ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // ----------------------------------------------------
            // 1. Constants and State Management
            // ----------------------------------------------------
            const API_BASE = 'https://falahsab.github.io/jedwal/';
            const CSV_PATHS = {
                leagues: `${API_BASE}csv/leagues.csv`,
                commentators: `${API_BASE}csv/commentators.csv`,
                channels: `${API_BASE}csv/channels.csv`,
                teamsFolder: `${API_BASE}teams/`
            };

            let leagues = [];
            let teams = {};
            let channels = [];
            let matches = [];
            let editIndex = null;
            let isNextDay = false;
            let showBtns = true;
            const logoCache = new Map();
            
            // DOM Elements
            const DOM = {
                dateEl: document.getElementById('todayDate'),
                leagueSelect: document.getElementById('leagueSelect'),
                matchTime: document.getElementById('matchTime'),
                homeTeam: document.getElementById('homeTeam'),
                awayTeam: document.getElementById('awayTeam'),
                commentator: document.getElementById('commentator'),
                channel: document.getElementById('channel'),
                homePreview: document.getElementById('homePreview'),
                awayPreview: document.getElementById('awayPreview'),
                addMatch: document.getElementById('addMatch'),
                nextDayState: document.getElementById('nextDayState'),
                matchesContainer: document.getElementById('matchesContainer'),
                systemMessage: document.getElementById('systemMessage')
            };

            // ----------------------------------------------------
            // 2. Utility & Data Functions
            // ----------------------------------------------------
            
            function displayDate() {
                const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
                const now = new Date();
                DOM.dateEl.textContent = `${days[now.getDay()]} ${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()}`;
            }

            function showMessage(message, type = 'error') {
                DOM.systemMessage.textContent = message;
                DOM.systemMessage.className = `system-message ${type}-message`;
                DOM.systemMessage.classList.remove('hidden');
                setTimeout(() => DOM.systemMessage.classList.add('hidden'), 5000);
            }

            function fetchCSV(url) {
                return new Promise((resolve, reject) => {
                    Papa.parse(url, {
                        download: true,
                        header: true,
                        complete: (results) => resolve(results.data.filter(row => Object.values(row).some(v => v))),
                        error: (error) => reject(error)
                    });
                });
            }

            function getLogoBase64(url) {
                if (!url || url.includes('undefined')) return Promise.resolve('');
                if (logoCache.has(url)) return Promise.resolve(logoCache.get(url));

                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        canvas.getContext('2d').drawImage(img, 0, 0);
                        const base64 = canvas.toDataURL();
                        logoCache.set(url, base64);
                        resolve(base64);
                    };
                    img.onerror = () => resolve('');
                    img.src = url;
                });
            }

            async function loadInitialData() {
                try {
                    const [leaguesData, commentatorsData, channelsData] = await Promise.all([
                        fetchCSV(CSV_PATHS.leagues),
                        fetchCSV(CSV_PATHS.commentators),
                        fetchCSV(CSV_PATHS.channels)
                    ]);

                    leagues = leaguesData;
                    channels = channelsData;
                    
                    populateSelects(DOM.leagueSelect, leagues, 'name', 'code', { logo: 'logo', color: 'color', extra: 'extraLogo' });
                    populateSelects(DOM.commentator, commentators, 'name', 'name');
                    populateSelects(DOM.channel, channels, 'name', 'name', { logo: 'logo' });
                    
                    if (leagues.length > 0) {
                        await loadTeams(leagues[0].code);
                    }
                    
                    const savedMatches = localStorage.getItem('matches');
                    if (savedMatches) {
                        matches = JSON.parse(savedMatches);
                    }

                } catch (error) {
                    showMessage('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ.', 'error');
                } finally {
                    const spinner = document.querySelector('.loading-spinner');
                    if(spinner) spinner.style.display = 'none';
                    render();
                }
            }
            
            function populateSelects(selectEl, data, textKey, valueKey, dataAttributes = {}) {
                selectEl.innerHTML = data.map(item => {
                    const dataAttrHTML = Object.entries(dataAttributes)
                        .map(([attr, key]) => `data-${attr}='${item[key] || ""}'`)
                        .join(' ');
                    return `<option value='${item[valueKey]}' ${dataAttrHTML}>${item[textKey]}</option>`;
                }).join('');
            }

            async function loadTeams(leagueCode) {
                if (!teams[leagueCode]) {
                    try {
                        const data = await fetchCSV(`${CSV_PATHS.teamsFolder}${leagueCode}_teams.csv`);
                        teams[leagueCode] = data;
                    } catch (error) {
                        showMessage(`ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ÙØ±Ù‚ Ø§Ù„Ø¯ÙˆØ±ÙŠ: ${leagueCode}`, 'error');
                        teams[leagueCode] = [];
                    }
                }
                const teamOptions = teams[leagueCode].map(t =>
                    `<option value='${t.name}' data-img='${t.img}'>${t.name}</option>`
                ).join('');
                
                DOM.homeTeam.innerHTML = DOM.awayTeam.innerHTML = teamOptions;
                updatePreview(DOM.homeTeam, DOM.homePreview, 'ğŸ ');
                updatePreview(DOM.awayTeam, DOM.awayPreview, 'âš½');
            }

            function updatePreview(selectEl, previewEl, defaultIcon) {
                const selectedOption = selectEl.selectedOptions[0];
                const imgUrl = selectedOption ? selectedOption.dataset.img : '';
                
                previewEl.innerHTML = defaultIcon;
                if (imgUrl) {
                    getLogoBase64(imgUrl).then(b64 => {
                        previewEl.innerHTML = b64 ? `<img src='${b64}' alt='Ø´Ø¹Ø§Ø± Ø§Ù„ÙØ±ÙŠÙ‚'/>` : defaultIcon;
                    });
                }
            }

            // ----------------------------------------------------
            // 3. Match Management
            // ----------------------------------------------------
            
            function saveMatches() {
                try {
                    localStorage.setItem('matches', JSON.stringify(matches));
                } catch (e) {
                    showMessage('Ø®Ø·Ø£: ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ.', 'error');
                }
            }

            function render() {
                DOM.matchesContainer.innerHTML = '';
                const matchesByLeague = {};
                matches.forEach(m => {
                    if (!matchesByLeague[m.league]) matchesByLeague[m.league] = [];
                    matchesByLeague[m.league].push(m);
                });

                leagues.forEach(l => {
                    const leagueMatches = matchesByLeague[l.code] || [];
                    if (leagueMatches.length === 0) return;

                    const section = document.createElement('div');
                    section.className = 'matches-section';

                    const header = document.createElement('div');
                    header.className = 'section-header';
                    header.style.color = l.color || '#333';

                    Promise.all([
                        getLogoBase64(l.logo),
                        getLogoBase64(l.extraLogo || l.extra)
                    ]).then(([leagueLogoB64, extraLogoB64]) => {
                        
                        const leagueLogoHTML = leagueLogoB64 ? `<img src='${leagueLogoB64}' class='league-logo' alt='${l.name}'>` : '';
                        const extraLogoHTML = extraLogoB64 ? `<img src='${extraLogoB64}' class='extra-logo-header' alt='Ø´Ø¹Ø§Ø± Ø¥Ø¶Ø§ÙÙŠ'>` : '';
                        
                        header.innerHTML = `
                            <div class="section-header-content">
                                ${leagueLogoHTML}
                                <span>${l.name}</span>
                            </div>
                            ${extraLogoHTML}
                        `;
                    });

                    section.appendChild(header);

                    leagueMatches.forEach((m) => {
                        const matchIndex = matches.indexOf(m);
                        const card = document.createElement('div');
                        card.className = `match-card ${matchIndex === editIndex ? 'is-editing' : ''}`;
                        card.style.setProperty('--match-card-bg', l.color || '#191919');

                        const [hours, minutes] = m.time.split(':');
                        let displayHours = parseInt(hours,10);
                        const ampm = displayHours >= 12 ? 'Ù…' : 'Øµ';
                        displayHours = displayHours % 12 || 12;

                        const editBtnStyle = `background: var(--warning-color); color: #333;`;
                        const deleteBtnStyle = `background: var(--delete-color); color: #fff;`;
                            
                        card.innerHTML = `
                            <div class="match_row">
                                <div class="team hometeam">
                                    <span class="the_team">${m.home}</span>
                                    <img src="${m.homeImg}" class="team_logo" alt="${m.home}">
                                </div>
                                <div class="middle_column">
                                    <div class="the_time">
                                        <span>${displayHours}:${minutes}</span>
                                        <span>${ampm}</span>
                                    </div>
                                    ${m.nextDay ? "<div class='next-day-label'>(Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ)</div>" : ""}
                                </div>
                                <div class="team awayteam">
                                    <img src="${m.awayImg}" class="team_logo" alt="${m.away}">
                                    <span class="the_team">${m.away}</span>
                                </div>
                            </div>

                            <div class="meta">
                                <div>ğŸ™ï¸ ${m.comm}</div>
                            </div>

                            ${m.chanLogo ? `<img src="${m.chanLogo}" class="channel-logo" alt="${m.chan}">` : ''}

                            <div class="action-btns" style="display:${showBtns ? 'flex' : 'none'}">
                                <button style="${editBtnStyle}" onclick="window.editMatchFunc(${matchIndex})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                <button style="${deleteBtnStyle}" onclick="window.deleteMatchFunc(${matchIndex})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                            </div>
                        `;
                        section.appendChild(card);
                    });

                    DOM.matchesContainer.appendChild(section);
                });
            }
            
            // ----------------------------------------------------
            // 4. Event Handlers
            // ----------------------------------------------------
            
            window.editMatchFunc = (index) => {
                const m = matches[index];
                editIndex = index;
                
                DOM.leagueSelect.value = m.league;
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±Ù‚ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙ…
                loadTeams(m.league).then(() => {
                    DOM.homeTeam.value = m.home;
                    DOM.awayTeam.value = m.away;
                    updatePreview(DOM.homeTeam, DOM.homePreview, 'ğŸ ');
                    updatePreview(DOM.awayTeam, DOM.awayPreview, 'âš½');
                    
                    DOM.matchTime.value = m.time;
                    DOM.commentator.value = m.comm;
                    DOM.channel.value = m.chan;
                    
                    isNextDay = m.nextDay;
                    document.getElementById('nextDayState').textContent = isNextDay ? 'âœ…' : 'âŒ';
                    
                    DOM.addMatch.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
                    DOM.addMatch.classList.add('warning-btn');
                    DOM.addMatch.classList.remove('primary-btn');
                    render();
                });
            };

            window.deleteMatchFunc = (index) => {
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©ØŸ')) {
                    matches.splice(index, 1);
                    saveMatches();
                    render();
                    if (editIndex === index) {
                        resetForm();
                    } else if (editIndex !== null && editIndex > index) {
                        editIndex--;
                    }
                }
            };
            
            function resetForm() {
                editIndex = null;
                isNextDay = false;
                DOM.addMatch.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©';
                DOM.addMatch.classList.remove('warning-btn');
                DOM.addMatch.classList.add('primary-btn');
                document.getElementById('nextDayState').textContent = 'âŒ';
                DOM.matchTime.value = '';
            }

            DOM.addMatch.onclick = async () => {
                const time = DOM.matchTime.value;
                const homeOption = DOM.homeTeam.selectedOptions[0];
                const awayOption = DOM.awayTeam.selectedOptions[0];
                const channelOption = DOM.channel.selectedOptions[0];

                if (!time || !homeOption || !awayOption || !channelOption) {
                    showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.', 'warning');
                    return;
                }

                const [homeImg, awayImg, chanLogo] = await Promise.all([
                    getLogoBase64(homeOption.dataset.img),
                    getLogoBase64(awayOption.dataset.img),
                    getLogoBase64(channelOption.dataset.logo || '')
                ]);
                
                const newMatch = {
                    league: DOM.leagueSelect.value,
                    home: homeOption.value,
                    away: awayOption.value,
                    time,
                    comm: DOM.commentator.value,
                    chan: DOM.channel.value,
                    homeImg,
                    awayImg,
                    chanLogo,
                    nextDay: isNextDay
                };

                if (editIndex !== null) {
                    matches[editIndex] = newMatch;
                    showMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                    resetForm();
                } else {
                    matches.push(newMatch);
                    showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                }

                saveMatches();
                render();
            };

            document.getElementById('nextDayBtn').onclick = () => {
                isNextDay = !isNextDay;
                DOM.nextDayState.textContent = isNextDay ? 'âœ…' : 'âŒ';
            };

            document.getElementById('toggleBtns').addEventListener('click', () => { showBtns = !showBtns; render(); });
            document.getElementById('deleteAll').addEventListener('click', () => {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§ØªØŸ')) {
                    matches = [];
                    saveMatches();
                    render();
                    resetForm();
                }
            });

            document.getElementById('downloadTable').addEventListener('click', () => {
                document.getElementById('downloadTable').disabled = true;
                document.getElementById('downloadTable').textContent = '...Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„';
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„ØªØµÙˆÙŠØ±
                const actionBtns = document.querySelectorAll('.action-btns');
                actionBtns.forEach(btn => btn.style.display = 'none');

                html2canvas(document.querySelector('.matches-wrapper > .card'), {
                    useCORS: true,
                    allowTaint: true,
                    scale: 3, 
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const link = document.getElementById('downloadLink');
                    link.href = canvas.toDataURL('image/png');
                    link.download = `Ø¬Ø¯ÙˆÙ„_Ù…Ø¨Ø§Ø±ÙŠØ§Øª_${DOM.dateEl.textContent.replace(/\s/g, '_')}.png`;
                    link.click();
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                    actionBtns.forEach(btn => btn.style.display = showBtns ? 'flex' : 'none');

                    document.getElementById('downloadTable').disabled = false;
                    document.getElementById('downloadTable').textContent = 'ğŸ“¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙƒØµÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø©';
                });
            });

            document.getElementById('finalView').addEventListener('click',()=>{
                alert('ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„Ø© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù‡Ø°Ù‡ØŒ ÙˆÙ„ÙƒÙ†Ù‡Ø§ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ ØµÙØ­Ø© Ø£Ø®Ø±Ù‰.');
            });

            DOM.leagueSelect.addEventListener('change', (e) => loadTeams(e.target.value));
            DOM.homeTeam.addEventListener('change', () => updatePreview(DOM.homeTeam, DOM.homePreview, 'ğŸ '));
            DOM.awayTeam.addEventListener('change', () => updatePreview(DOM.awayTeam, DOM.awayPreview, 'âš½'));

            // Initialization
            displayDate();
            loadInitialData();
        });
    </script>

</body>
</html>
