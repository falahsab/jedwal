<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>جدول مباريات اليوم - لوحة التحكم</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
    *{box-sizing:border-box;font-family:'Cairo',Tahoma,system-ui,Segoe UI,Arial}
    body{margin:0;padding:18px;background:#f9f9f9;color:#222;min-height:100vh}
    .container{max-width:1100px;margin:0 auto}
    header{background:#3498db;color:#fff;padding:12px 16px;border-radius:8px;margin-bottom:18px;text-align:center;font-size:22px;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr 400px;gap:14px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 4px 15px rgba(0,0,0,0.08)}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    select,input[type="datetime-local"]{background:transparent;border:1px solid rgba(0,0,0,0.12);padding:8px;border-radius:8px;color:#222;width:100%}
    label{font-size:13px;color:#555;display:block;margin-bottom:4px}
    .logo{width:40px;height:40px;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .logo img{width:100%;height:100%;object-fit:contain}
    .btn{background:#3498db;color:#fff;padding:10px;border-radius:10px;border:none;cursor:pointer;font-weight:700;width:100%}
    .matches-section{margin-bottom:16px}
    .section-header{display:flex;align-items:center;gap:8px;font-weight:700;font-size:16px;margin-bottom:8px}
    .match-card{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px;border-radius:10px;margin-bottom:8px;border:1px solid rgba(0,0,0,0.05);background:#fdfdfd}
    .teams{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:150px}
    .team{display:flex;flex-direction:column;align-items:center;font-weight:600}
    .meta{display:flex;flex-direction:column;gap:4px;color:#555;font-size:13px;text-align:center}
    #downloadLink{display:none}
  </style>
</head>
<body>
  <div class="container">
    <header>⚽ جدول مباريات اليوم</header>

    <div class="grid">
      <div class="card form">
        <div class="row">
          <div style="flex:1">
            <label>الدوري</label>
            <select id="leagueSelect"></select>
          </div>
          <div style="width:120px">
            <label>الوقت</label>
            <input id="matchTime" type="datetime-local" />
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>الفريق المضيف</label>
            <select id="homeTeam"></select>
          </div>
          <div style="width:50px">
            <label>&nbsp;</label>
            <div class="logo" id="homePreview">🏠</div>
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>الفريق الضيف</label>
            <select id="awayTeam"></select>
          </div>
          <div style="width:50px">
            <label>&nbsp;</label>
            <div class="logo" id="awayPreview">⚽</div>
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>المعلق</label>
            <select id="commentator"></select>
          </div>
          <div style="width:180px">
            <label>القناة الناقلة</label>
            <select id="channel"></select>
          </div>
        </div>
        <button id="addMatch" class="btn">➕ إضافة المباراة</button>
      </div>

      <div>
        <div class="card">
          <div id="matchesContainer"></div>
        </div>
      </div>
    </div>

    <button id="finalView" class="btn" style="margin-top:12px;">🔗 عرض الجدول النهائي</button>
    <button id="downloadTable" class="btn" style="margin-top:8px;">📸 تحميل الجدول كصورة</button>
    <a id="downloadLink"></a>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded',()=>{
      // ضع هنا روابط ملفات CSV الخاصة بك
      const leaguesCSV = 'csv/leagues.csv';
      const commentatorsCSV = 'csv/commentators.csv';
      const channelsCSV = 'csv/channels.csv';
      const teamsCSVFolder = 'teams/'; // يجب أن يكون اسم كل ملف فرق <leagueCode>_teams.csv

      let leagues=[], teams={}, commentators=[], channels=[];

      function fetchCSV(url, callback){
        Papa.parse(url,{download:true,header:true,complete:results=>callback(results.data)});
      }

      function populateLeagues(){
        fetchCSV(leaguesCSV, data=>{
          leagues=data;
          const leagueSelect=document.getElementById('leagueSelect');
          leagueSelect.innerHTML=leagues.map(l=>`<option value='${l.code}'>${l.name}</option>`).join('');
          loadTeams(leagueSelect.value);
        });
      }

      function loadTeams(leagueCode){
        fetchCSV(`${teamsCSVFolder}${leagueCode}_teams.csv`, data=>{
          teams[leagueCode]=data;
          const homeTeam=document.getElementById('homeTeam');
          const awayTeam=document.getElementById('awayTeam');
          homeTeam.innerHTML=awayTeam.innerHTML=data.map(t=>`<option value='${t.name}' data-img='${t.img}'>${t.name}</option>`).join('');
          updatePreview(homeTeam,'homePreview');
          updatePreview(awayTeam,'awayPreview');
        });
      }

      function fetchCommentators(){
        fetchCSV(commentatorsCSV, data=>{
          commentators=data.map(c=>c.name);
          document.getElementById('commentator').innerHTML=commentators.map(c=>`<option>${c}</option>`).join('');
        });
      }

      function fetchChannels(){
        fetchCSV(channelsCSV, data=>{
          channels=data.map(c=>c.name);
          document.getElementById('channel').innerHTML=channels.map(c=>`<option>${c}</option>`).join('');
        });
      }

      function updatePreview(selectEl,previewId){
        const selected=selectEl.selectedOptions[0];
        const img=selected.dataset.img;
        document.getElementById(previewId).innerHTML=img?`<img src='${img}'/>`:'⚽';
      }

      populateLeagues(); fetchCommentators(); fetchChannels();
      document.getElementById('leagueSelect').addEventListener('change',e=>loadTeams(e.target.value));
      document.getElementById('homeTeam').addEventListener('change',()=>updatePreview(document.getElementById('homeTeam'),'homePreview'));
      document.getElementById('awayTeam').addEventListener('change',()=>updatePreview(document.getElementById('awayTeam'),'awayPreview'));

      let matches=[]; if(localStorage.getItem('matches')){matches=JSON.parse(localStorage.getItem('matches')); render();}

      document.getElementById('addMatch').onclick=()=>{
        const league=document.getElementById('leagueSelect').value;
        const home=document.getElementById('homeTeam').value;
        const away=document.getElementById('awayTeam').value;
        const time=document.getElementById('matchTime').value;
        const comm=document.getElementById('commentator').value;
        const chan=document.getElementById('channel').value;
        const homeImg=document.getElementById('homeTeam').selectedOptions[0].dataset.img;
        const awayImg=document.getElementById('awayTeam').selectedOptions[0].dataset.img;
        if(!time){alert('ادخل وقت المباراة'); return;}
        matches.push({league,home,away,time,comm,chan,homeImg,awayImg});
        localStorage.setItem('matches',JSON.stringify(matches));
        render();
        document.getElementById('matchTime').value='';
      };

      function render(){
        const matchesContainer=document.getElementById('matchesContainer');
        matchesContainer.innerHTML='';
        leagues.forEach(l=>{
          const leagueMatches=matches.filter(m=>m.league===l.code);
          if(leagueMatches.length>0){
            const section=document.createElement('div'); section.className='matches-section';
            const header=document.createElement('div'); header.className='section-header';
            header.innerHTML=`<img src='${l.logo}' style='width:24px;height:24px'> ${l.name}`;
            section.appendChild(header);
            leagueMatches.forEach(m=>{
              const card=document.createElement('div'); card.className='match-card';
              card.innerHTML=`<div class='teams'><div class='team'>${m.home}<div class='logo'><img src='${m.homeImg}'/></div></div><div>⏰ ${new Date(m.time).toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'})}</div><div class='team'><div class='logo'><img src='${m.awayImg}'/></div>${m.away}</div></div><div class='meta'><div>🎙️ ${m.comm}</div><div>📺 ${m.chan}</div></div>`;
              section.appendChild(card);
            });
            matchesContainer.appendChild(section);
          }
        });
      }

      document.getElementById('finalView').addEventListener('click',()=>{
        const finalWindow=window.open('','_blank');
        if(finalWindow){
          finalWindow.onload=()=>{
            finalWindow.document.write(`<html lang='ar' dir='rtl'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>جدول المباريات النهائي</title><style>body{font-family:'Cairo',Tahoma,sans-serif;padding:16px}.match-card{margin-bottom:12px;padding:10px;border-radius:8px;border:1px solid #ccc;display:flex;flex-direction:column;align-items:center}.teams{display:flex;flex-direction:column;align-items:center;gap:6px}.logo img{width:32px;height:32px}</style></head><body>${document.getElementById('matchesContainer').innerHTML}</body></html>`);
            finalWindow.document.close();
          };
        }else{alert('تعذر فتح نافذة جديدة.');}
      });

      document.getElementById('downloadTable').addEventListener('click',()=>{
        html2canvas(document.getElementById('matchesContainer')).then(canvas=>{
          const downloadLink=document.getElementById('downloadLink');
          downloadLink.href=canvas.toDataURL('image/png');
          downloadLink.download='matches.png';
          downloadLink.click();
        });
      });
    });
  </script>
</body>

</html>
